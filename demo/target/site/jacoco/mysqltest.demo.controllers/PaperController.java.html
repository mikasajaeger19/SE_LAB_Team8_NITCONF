<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaperController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo</a> &gt; <a href="index.source.html" class="el_package">mysqltest.demo.controllers</a> &gt; <span class="el_source">PaperController.java</span></div><h1>PaperController.java</h1><pre class="source lang-java linenums">package mysqltest.demo.controllers;
import java.io.IOException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.time.LocalDate;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

import mysqltest.demo.models.Paper;
import mysqltest.demo.models.User;
import mysqltest.demo.models.Version;
import mysqltest.demo.repositories.PaperRepository;
import mysqltest.demo.repositories.VersionRepository;

/**
 * Controller class for managing Paper-related operations.
 */
@RestController
@RequestMapping(path = &quot;/paper&quot;)
<span class="fc" id="L25">public class PaperController {</span>

    @Autowired
    private PaperRepository paperRepository;
    @Autowired
    private VersionRepository versionRepository;

    /**
     * Adds a new Paper to the system.
     *
     * @param paper The Paper to be added.
     * @return A String indicating the result of the operation.
     */
    @PostMapping(path = &quot;/add&quot;)
    public ResponseEntity&lt;Paper&gt; addNewPaper(@RequestBody Paper paper){
<span class="pc bpc" id="L40" title="2 of 6 branches missed.">        if(paper.getAuthorId() == null || paper.getTitle() == null || paper.getShortdesc() == null){</span>
<span class="fc" id="L41">            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(null);</span>
        }

        // @ResponseBody means the returned String is the response, not a view name
<span class="fc" id="L45">        Version version = new Version();</span>
<span class="fc" id="L46">        version.setAbstractUrl(paper.getAbstractUrl());</span>
<span class="fc" id="L47">        version.setTitle(paper.getTitle());</span>
<span class="fc" id="L48">        version.setReleaseDate(paper.getUploadDate());</span>
<span class="fc" id="L49">        paperRepository.save(paper);</span>
<span class="fc" id="L50">        version.setPaperId(paper.getId()); // Change to use the ID directly</span>
<span class="fc" id="L51">        versionRepository.save(version);</span>
        
<span class="fc" id="L53">        return ResponseEntity.ok(paper);</span>
    }

    // @PostMapping(path = &quot;/upload/{paperId}&quot;)
    // public ResponseEntity&lt;String&gt; uploadFile(@RequestParam(&quot;file&quot;) MultipartFile file, @PathVariable String paperId) {
    //     //Paper paper = paperRepository.findByPaperId(paperId);
    //     return ResponseEntity.ok(&quot;File uploaded&quot;);
    //     // System.out.println(&quot;hello nigga&quot;);
    //     // paper.setFile(file.getBytes());

    //     // if (paper != null) {
    //     //     System.out.println(&quot;entered&quot;);
    //     //     Version version = new Version();
    //     //     version.setAbstractUrl(paper.getAbstractUrl());
    //     //     version.setTitle(paper.getTitle());
    //     //     version.setReleaseDate(paper.getUploadDate());
    //     //     version.setPaperId(paper.getId()); // Change to use the ID directly
    //     //     // paper.setFile(file.getBytes());
    //     //     version.setFile(file.getBytes());
    //     //     versionRepository.save(version);
    //     //     paperRepository.save(paper);
    //     //     return ResponseEntity.ok(&quot;File uploaded&quot;);
    //     // } else {
    //     //     return ResponseEntity.ok(&quot;Paper not found&quot;);
    //     // }
    // }


    @PostMapping(path = &quot;/upload/{paperId}&quot;)
public ResponseEntity&lt;String&gt; uploadFile(@RequestParam(&quot;file&quot;) MultipartFile file, @PathVariable String paperId) {
    try {
        // Process the file
<span class="fc" id="L85">        byte[] fileBytes = file.getBytes();</span>

<span class="fc" id="L87">        Paper paper = paperRepository.findByPaperId(paperId);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (paper == null) {</span>
<span class="nc" id="L89">            return ResponseEntity.ok(&quot;Paper not found&quot;);</span>
            
        } else {
<span class="fc" id="L92">            Version version = new Version();</span>
<span class="fc" id="L93">            version.setAbstractUrl(paper.getAbstractUrl());</span>
<span class="fc" id="L94">            version.setTitle(paper.getTitle());</span>
<span class="fc" id="L95">            version.setReleaseDate(paper.getUploadDate());</span>
<span class="fc" id="L96">            version.setPaperId(paper.getId());</span>
<span class="fc" id="L97">            version.setFile(fileBytes);</span>
<span class="fc" id="L98">            paper.setFile(fileBytes);</span>
<span class="fc" id="L99">            versionRepository.save(version);</span>
<span class="fc" id="L100">            paperRepository.save(paper);</span>
<span class="fc" id="L101">            return ResponseEntity.ok(&quot;File uploaded&quot;);</span>
        }
<span class="nc" id="L103">    } catch (IOException e) {</span>
<span class="nc" id="L104">        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(&quot;Failed to upload file: &quot; + e.getMessage());</span>
    }
}
    /**
     * Retrieves a Paper by its ID.
     *
     * @param paperId The ID of the Paper to retrieve.
     * @return The retrieved Paper.
     */
    @GetMapping(path = &quot;/{paperId}&quot;)
    public ResponseEntity &lt;Paper&gt; getPaper(@PathVariable String paperId) { // Change the parameter type to String
<span class="fc" id="L115">        Paper result =  paperRepository.findById(paperId).orElse(null);</span>
<span class="fc" id="L116">        return ResponseEntity.ok(result);</span>
    }

    @GetMapping(&quot;/doc/{id}&quot;)
    public ResponseEntity&lt;byte[]&gt; getDocument(@PathVariable String id) {
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (id == null)</span>
<span class="nc" id="L122">            return ResponseEntity.notFound().build();</span>
        
<span class="fc" id="L124">        Paper paper = paperRepository.findByPaperId(id);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        if (paper == null)</span>
<span class="fc" id="L126">            return ResponseEntity.notFound().build();</span>
        
<span class="fc" id="L128">        byte[] file = paper.getFile();</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (file == null)</span>
<span class="fc" id="L130">            return ResponseEntity.notFound().build();</span>
        
<span class="fc" id="L132">        return ResponseEntity.ok()</span>
<span class="fc" id="L133">                .contentType(MediaType.APPLICATION_PDF)</span>
<span class="fc" id="L134">                .body(file);</span>
    }
    


    /**
     * Updates an existing Paper with the provided information.
     *
     * @param paper   The updated Paper information.
     * @param paperId The ID of the Paper to be updated.
     * @return A String indicating the result of the operation.
     */
    @PutMapping(path = &quot;/update/{paperId}&quot;)
    public ResponseEntity &lt;String&gt; updatePaperDetails(@RequestBody Paper paper, @PathVariable String paperId) { // Change the parameter type to String
<span class="fc" id="L148">        Paper existingPaper = paperRepository.findByPaperId(paperId);</span>

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (existingPaper != null) {</span>
<span class="fc" id="L151">            existingPaper.setTitle(paper.getTitle());</span>
<span class="fc" id="L152">            existingPaper.setApproved(paper.getApproved());</span>
<span class="fc" id="L153">            existingPaper.setShortdesc(paper.getShortdesc());</span>
<span class="fc" id="L154">            existingPaper.setAbstractUrl(paper.getAbstractUrl());</span>
<span class="fc" id="L155">            existingPaper.setTags(paper.getTags());</span>
<span class="fc" id="L156">            existingPaper.setUploadDate(paper.getUploadDate());</span>
<span class="fc" id="L157">            existingPaper.setAuthorId(paper.getAuthorId());</span>
<span class="fc" id="L158">            paperRepository.save(existingPaper);</span>
<span class="fc" id="L159">            return ResponseEntity.ok(&quot;Updated&quot;);</span>
        } else {
<span class="nc" id="L161">            return ResponseEntity.ok(&quot;Error&quot;);</span>
        }
    }

    @PutMapping(path = &quot;/reupload/{paperId}&quot;)
    public ResponseEntity &lt;String&gt; reuploadPaper(@PathVariable String paperId, @RequestParam(&quot;file&quot;) MultipartFile file) throws IOException{ // Change the parameter type to String
<span class="fc" id="L167">        Paper existingPaper = paperRepository.findByPaperId(paperId);</span>

<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (existingPaper != null) {</span>
            
<span class="fc" id="L171">            LocalDate currentDate = LocalDate.now();</span>
            // Save the updated paper
<span class="fc" id="L173">            existingPaper.setFile(file.getBytes());</span>
<span class="fc" id="L174">            existingPaper.setUploadDate(currentDate);</span>
<span class="fc" id="L175">            paperRepository.save(existingPaper);</span>

            // Create a new version entry for the reupload
<span class="fc" id="L178">            Version newVersion = new Version();</span>
<span class="fc" id="L179">            newVersion.setAbstractUrl(existingPaper.getAbstractUrl());</span>
<span class="fc" id="L180">            newVersion.setTitle(existingPaper.getTitle());</span>
<span class="fc" id="L181">            newVersion.setReleaseDate(currentDate);</span>
<span class="fc" id="L182">            newVersion.setPaperId(existingPaper.getId()); // Change to use the ID directly</span>
<span class="fc" id="L183">            newVersion.setFile(file.getBytes());</span>
<span class="fc" id="L184">            versionRepository.save(newVersion);</span>

<span class="fc" id="L186">            return ResponseEntity.ok(&quot;Updated&quot;);</span>
        } else {
<span class="nc" id="L188">            return ResponseEntity.ok(&quot;Error&quot;);</span>
        }
    }

    /**
     * Retrieves Papers authored by the currently authenticated user.
     *
     * @return Iterable of Papers authored by the current user.
     */
    // @GetMapping(path = &quot;/&quot;)
    // public ResponseEntity &lt;Iterable&lt;Paper&gt;&gt; getMyPapers() {
    //     User currentUser = (User) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    //     Iterable &lt;Paper&gt; result = paperRepository.findByAuthorId(currentUser.getId());

    //     return ResponseEntity.ok(result);
    // }

    /**
     * Retrieves all Papers in the system.
     *
     * @return Iterable of all Papers.
     */
    // @GetMapping(path = &quot;/all&quot;)
    // public ResponseEntity &lt;Iterable&lt;Paper&gt;&gt; getAllPapers() {
    //     Iterable&lt;Paper&gt; result = paperRepository.findAll();
    //     return ResponseEntity.ok(result);
    // }

    /**
     * Retrieves Papers authored by a specific user.
     *
     * @param id The ID of the author.
     * @return Iterable of Papers authored by the specified user.
     */
    @GetMapping(path = &quot;/author/{id}&quot;)
    public ResponseEntity &lt;Iterable&lt;Paper&gt;&gt; getPaperById(@PathVariable String id) {
<span class="fc" id="L224">        Iterable&lt;Paper&gt; result = paperRepository.findByAuthorId(id);</span>
<span class="fc" id="L225">        return ResponseEntity.ok(result);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>